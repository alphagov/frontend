<% content_for :extra_javascript do %>
	<%= javascript_include_tag 'trackers/findmynearest.js', :defer=>"defer" %>
<% end %>
<section id="content" role="main" class="group">

  <header class="page-header group">
   <hgroup>
     <h1><span>Find My Nearest</span> <%= @place.title %></h1>
   </hgroup>
  </header>
	<div class="article-container group">
	 	<article role="article" class="group">
	    <div class="inner">

	      <div class="find-nearest">
	        <% unless @options.any? %>
	        <%= to_govspeak(@place.introduction) %>
	        <% end %>

     	     <h2>What you need to know</h2>
     				<div class="more">
     				<% if @place.expectations.any? %>
     				  <ul class="helpers group">
     				  <% @place.expectations.each do |e| %>
     				    <li class="<%= e.css_class %>">
     				      <%= e.text %>
     				    </li>
     				  <% end %>
     				  </ul>
     				<% end %>

   	        <%= to_govspeak(@place.more_information) %>
   				</div>

          <form method="get" id="local-locator-form">
  	        <fieldset>
  	          <legend class="visuallyhidden">Postcode lookup</legend>
  	          <% if @edition %>
  	            <input type="hidden" name="edition" value="<%= @edition %>">
  	          <% end %>
  	          <div class="ask_location <%= geo_known_to_at_least?('ward') ? 'removing' : '' %>">
  	            <label for="user-postcode">Enter a UK postcode <input id="user-postcode" name="postcode" type="text" placeholder="e.g. SW1A 2AA"></label>
  	            <input type="submit" value="Find my nearest â†’" class="button">
  	          </div>

  	          <div class="finding_location hidden">
  	            <p>Locating you&hellip;<input type="hidden" name="lon" value="<%= geo_known_to_at_least?('ward') ? geo_header['fuzzy_point']['lon'] : '' %>"><input type="hidden" name="lat" value="<%= geo_known_to_at_least?('ward') ? geo_header['fuzzy_point']['lat'] : '' %>"></p>
  	          </div>
  	          <div class="found_location <%= geo_known_to_at_least?('ward') ? '' : 'hidden' %>">
  	            <p class="friendly-name">We think you&rsquo;re in <strong><%= geo_header['friendly_name'] if geo_known_to_at_least?('ward') %></strong>. <a class="change-location" href="#"><%= "Not in <span class=\"friendly-name\">#{geo_header['friendly_name']}</span>?".html_safe if geo_known_to_at_least?('ward') %></a></p>
  	          </div>
  	        </fieldset>
	        </form>
	      </div>


	     <% if @options.any? %>
	       <h3 id="options-header">Your nearest options are...</h3>
	       <ol id="options">
	         <%= mustache_partial '_option.html', {'options' => @options} %>
	       </ol>
	     <% else %>
	       <h3 id="options-header" style="display:none">Your nearest options are:</h3>
	       <ol id="options">
	       </ol>
	     <% end %>

			</div>

		</article>
    <%= render 'publication_metadata', :publication => @place, :artefact => @artefact, :api_links => Hash[[:kml, :json, :csv].map { |format| [format, "#{@place.place_type}.#{format}"] }] %>
	</div>
</section>

<%= render 'related' %>

  <script id="option-template" type="text/x-mustache-template">
  <%= mustache_direct '_option.html' %>
  </script>

  <script>

  $(document).ready(function() {

      var load_new_locations = function() {
        var the_href = "<%= load_places_path(@place.slug) + "?edition=#{@edition}" %>";
        $.getJSON(the_href, function (data) {
          $('#options').html($.mustache($('#option-template').html(), {options: data}));
          _gaq.push(['_trackEvent', 'Citizen-Format-Findmynearest', 'Success-results']);
          $('#options-header').show();
        });
      }

      var remove_existing_location_data = function() {
        $("#options").html('');
        $('#options-header').hide();
      }

      AlphaGeo.locate('#local-locator-form');
      $('#local-locator-form').attr('action',"/locator.json");

      $(document).bind('location-removed', function(e, message) {
        remove_existing_location_data();
      });

      $(document).bind('location-changed', function(e, data) {
        remove_existing_location_data();
      });

      $(document).bind('location-changed', function(e, data) {
        load_new_locations();
      });

    });
    </script>
    <style type="text/css" media="screen">
      .removing { display: none; }
    </style>
